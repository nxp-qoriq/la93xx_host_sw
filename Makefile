#SPDX-License-Identifier: GPL-2.0
#Copyright 2017, 2021-2025 NXP

CC              = $(CROSS_COMPILE)gcc
AR              = $(CROSS_COMPILE)ar
LD              = $(CROSS_COMPILE)ld

KERNEL_DIR ?=

ifdef SYSROOT_PATH
LDFLAGS := --sysroot=${SYSROOT_PATH}
CFLAGS := --sysroot=${SYSROOT_PATH}
endif

VERSION_STRING :=\"v3.x\"

INSTALL_DIR ?= ${PWD}/install
LIB_INSTALL_DIR := ${INSTALL_DIR}/usr/lib
BIN_INSTALL_DIR := ${INSTALL_DIR}/usr/bin
MODULE_INSTALL_DIR := ${INSTALL_DIR}/kernel_module
CONFIG_INSTALL_DIR := ${INSTALL_DIR}/etc/config/la9310_config/
SCRIPTS_INSTALL_DIR := ${INSTALL_DIR}/etc
FIRMWARE_INSTALL_DIR := ${INSTALL_DIR}/lib/firmware

COMMON_DIR := ${PWD}/common/
API_DIR := ${PWD}/api/
UAPI_DIR := ${PWD}/uapi/
LIB_DIR := ${PWD}/lib/
LA9310_DRV_HEADER_DIR := ${PWD}/kernel_driver/la9310shiva/

INCLUDES += -I${API_DIR}
INCLUDES  += -I${LA9310_COMMON_HEADERS}
COMMON_INCLUDES += -I${COMMON_DIR}

CFLAGS += ${COMMON_INCLUDES}
HOST_CFLAGS += ${COMMON_INCLUDES}
GIT_VERSION :=\"$(shell git describe --abbrev=0 --tags)\"

# Config Tweak handles
DEBUG ?= 1
BOOTROM_USE_EDMA ?= 1
IMX_SDR ?= 0
IMX_SEEVE ?= 0
NLM ?= 0
EXTRA_RMMOD_SCRIPT ?= ""

export CC LIB_INSTALL_DIR BIN_INSTALL_DIR SCRIPTS_INSTALL_DIR MODULE_INSTALL_DIR \
	FIRMWARE_INSTALL_DIR
export CONFIG_INSTALL_DIR API_DIR LIB_DIR KERNEL_DIR COMMON_DIR UAPI_DIR LA9310_DRV_HEADER_DIR
export INCLUDES CFLAGS VERSION_STRING LDFLAGS GIT_VERSION
export DEBUG BOOTROM_USE_EDMA IMX_SDR IMX_SEEVE EXTRA_RMMOD_SCRIPT

ifeq ($(IMX_SDR),1)
	export BSP_VERSION := $(shell git describe --tags --abbrev=11 --dirty --match "la12*")
	CFLAGS += -DIMX_SDR
else ifeq ($(IMX_SEEVE),1)
	export BSP_VERSION := $(shell git describe --tags --abbrev=11 --dirty --match "la12*")
	CFLAGS += -DIMX_SEEVE
endif

ifneq ($(BSP_VERSION),)
	GIT_VERSION:=\"${BSP_VERSION}\"
endif

ifneq ($(GIT_VERSION),)
	VERSION_STRING :=${GIT_VERSION}
endif

CFLAGS += -DVERSION=${GIT_VERSION}
CFLAGS += -Wall -DLA9310_HOST_SW_VERSION="${VERSION_STRING}" -Wno-unused-function -Wno-unused-variable

ifeq (${DEBUG}, 1)
CFLAGS += -DDEBUG
endif

DIRS ?= lib app kernel_driver firmware scripts

CLEAN_DIRS = $(patsubst %, %_clean, ${DIRS})
INSTALL_DIRS = $(patsubst %, %_install, ${DIRS})

.PHONY: ${DIRS} ${CLEAN_DIRS} ${INSTALL_DIRS}

default: all

${DIRS}:
	${MAKE} -C $@ all

all: ${DIRS}

${CLEAN_DIRS}:
	${MAKE} -C $(patsubst %_clean, %, $@) clean
	rm -rf ${LIB_INSTALL_DIR}/*;
	rm -rf ${BIN_INSTALL_DIR}/*;
	rm -rf ${SCRIPTS_INSTALL_DIR}/*;
	rm -rf ${CONFIG_INSTALL_DIR}/*;
	rm -rf ${INSTALL_DIR};

${INSTALL_DIRS}:
	${MAKE} -j1 -C $(patsubst %_install, %, $@) install

install: ${INSTALL_DIRS}

clean: ${CLEAN_DIRS}
